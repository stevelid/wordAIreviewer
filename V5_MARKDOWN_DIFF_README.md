# AI Document Reviewer V5 README

## Overview
V5 keeps your proven VBA V4 apply engine, but changes the authoring path:

1. Word exports an annotated DSM markdown file (`_dsm.md`).
2. An LLM proposes edits using `SEARCH/REPLACE` blocks.
3. `reviewer_agent.py` translates those blocks into V4-compatible `tool_calls` JSON.
4. Word imports the JSON and applies tracked changes with the existing VBA logic.

This avoids large JSON generation directly from the model while preserving deterministic targeting.

## What Is Already Implemented
- `wordAIreviewer.bas` now exports both:
  - `%TEMP%\claude_review\{doc_stem}_dsm.md`
  - `%TEMP%\claude_review\{doc_stem}_dsm.json`
- Paragraph lines in markdown are annotated as `[P#] ...`.
- Table cells in markdown are annotated as `[T#.H.C#]` and `[T#.R#.C#]`.
- `reviewer_agent.py` supports:
  - Automatic runner mode (`codex` or `claude`)
  - Manual parse mode from file or stdin paste
  - Output to `%TEMP%\claude_review\{doc_stem}_toolcalls.json`
  - Prompt loading from `prompt.txt` (single source of truth for LLM instructions)

## Prerequisites
- Microsoft Word with your VBA macros enabled.
- Python 3 available as `python`.
- Optional for automatic mode:
  - `codex` CLI and/or `claude` CLI installed and authenticated.

## File Locations
Default exchange folder:
- `%TEMP%\claude_review\`

Files:
- Exported markdown DSM: `{doc_stem}_dsm.md`
- Exported JSON DSM (compat): `{doc_stem}_dsm.json`
- LLM raw response archive: `{doc_stem}_llm_response.txt`
- Generated tool calls: `{doc_stem}_toolcalls.json`

## End-to-End Usage

### 1. Export from Word
In Word, run:
- Ribbon button: `Export to AI` (if wired), or
- Macro: `V4_ExportDocumentMapToFile`

This writes `_dsm.md` and `_dsm.json` to `%TEMP%\claude_review\`.

### 2A. Run Automatic LLM Mode
From terminal in this repo:

```powershell
python reviewer_agent.py --file 6246.260211.NIA
```

Optional flags:

```powershell
python reviewer_agent.py --file 6246.260211.NIA --runner auto
python reviewer_agent.py --file 6246.260211.NIA --runner codex
python reviewer_agent.py --file 6246.260211.NIA --runner claude --model sonnet
```

`--file` accepts either:
- document stem (`6246.260211.NIA`) or
- full path to a `_dsm.md` file.

### 2B. Run Manual Mode (No API/No Auto CLI Run)
Use this when you already have model output text from another interface.

Parse from saved text file:

```powershell
python reviewer_agent.py --file 6246.260211.NIA --manual-output-file C:\path\llm_output.txt
```

Parse from pasted stdin:

```powershell
python reviewer_agent.py --file 6246.260211.NIA --manual-paste
```

Then paste the full `SEARCH/REPLACE` response and end input with `Ctrl+Z` then Enter (Windows).

### 3. Import Back Into Word
In Word, run:
- Ribbon button: `Import AI Review` (if wired), or
- Macro: `V4_ImportAndApplyToolCalls`

Word reads `%TEMP%\claude_review\{doc_stem}_toolcalls.json` and applies edits with tracked changes.

## LLM Output Requirements
The parser expects blocks like:

```text
<<<<<<< SEARCH
[P12] Original paragraph text.
=======
[P12] Updated paragraph text.
>>>>>>> REPLACE
```

For table rows:

```text
<<<<<<< SEARCH
| [T2.R2.C1] Pos 2 | [T2.R2.C2] 61 | [T2.R2.C3] High wind |
=======
| [T2.R2.C1] Pos 2 | [T2.R2.C2] 58 | [T2.R2.C3] High wind |
>>>>>>> REPLACE
```

Notes:
- IDs must be present and correct.
- Parser generates `replace_text` tool calls.
- Row edits are diffed per cell; only changed cells become tool calls.
- Whole-table replacement is intentionally not generated by this pipeline.
- If no edits are needed, `NO_CHANGES` is accepted and results in `0` tool calls.

## LLM Operating Instructions (Pass-Through Pack)
Use `prompt.txt` as the canonical instruction pack for any model used with this workflow.

Minimum rules for any LLM:
- Input is annotated DSM markdown with deterministic IDs (`[P#]`, `[T#.H.C#]`, `[T#.R#.C#]`).
- Output must be only `SEARCH/REPLACE` blocks (or exactly `NO_CHANGES`).
- `SEARCH` text must be exact, character-for-character from DSM markdown.
- Preserve IDs in both `SEARCH` and `REPLACE`.
- Keep edits atomic and local; do not bundle distant edits in one block.
- Do not use placeholders (`...`) or partial snippets.
- Never redraw or replace a full table; edit row/cell text only.
- Optional comments are supported as `[COMMENT: ...]` inside REPLACE text.

Recommended handoff pattern for external/manual LLM use:
1. Send `prompt.txt` as system instructions.
2. Send the full `_dsm.md` as the user content.
3. Save model output as plain text.
4. Parse with:

```powershell
python reviewer_agent.py --file 6246.260211.NIA --manual-output-file C:\path\llm_output.txt
```

This keeps manual and automatic paths behaviorally aligned.

## Command Reference
Show help:

```powershell
python reviewer_agent.py --help
```

Key arguments:
- `--file` (required): doc stem or `_dsm.md` path
- `--runner auto|codex|claude` (default `auto`)
- `--model <name>` optional runner model override
- `--manual-output-file <path>` manual parse from file
- `--manual-paste` manual parse from stdin
- `--temp-dir <path>` override exchange directory
- `--raw-output <path>` override raw response output path
- `--toolcalls-out <path>` override tool calls JSON path

## Troubleshooting
- `DSM markdown not found`
  - Ensure export macro ran successfully and `_dsm.md` exists in `%TEMP%\claude_review\`.
- `codex CLI not found` / `claude CLI not found`
  - Install the CLI or use manual mode.
- `Blocks parsed: 0`
  - LLM output did not contain valid `SEARCH/REPLACE` markers.
- `Tool calls generated: 0`
  - Either no diffs were found, IDs were invalid/missing, or blocks were unchanged.
- Word import says file missing
  - Confirm `{doc_stem}_toolcalls.json` exists in `%TEMP%\claude_review\` and stem matches active doc name.

## Safety / Behavior Notes
- Existing VBA apply core is unchanged (`ProcessSuggestionV4`, `ResolveTargetToRange`, granular diff).
- Import step creates backup before apply in the same temp folder.
- Keep the document saved before running export/import macros.
